# 传统数据库瓶颈（MySQL）

面对**海量数据（1000万）**和**高并发**，处理瓶颈一般是在数据库上面，可合理使用缓存技术和队列技术进行处理，静态资源可以用 Nginx，apache 等静态服务器加动态服务器处理。

### 一、个人总结

#### 1.1 数据库优化

1. 分表分区（物理层调优）

   + 分表：大表拆小表；进行**冷热分离**（将大字段、访问频率低的字段拆分到单独的表中存储，分离冷热数据）
     `（原则是提高查询数据的命中率，提高查询速度）`
     这样处理有利于有效利用缓存，防止读入无用的冷数据，减少磁盘 IO，同时保证热数据常驻内存提高缓存命中率
   + 分区：将经常查询的表的数据文件单独放到较快的磁盘中，提高速度
   + 历史数据拆分：将历史数据按照时间（或者其他字段）进行分拆，过时的放到历史表，业务表只存放最近的数据

2. 数据库集群

   使用集群，利用多个数据库将业务分摊到不同的数据库，减轻单个数据库的压力

   （就是多买几个新的服务器，减轻单个的压力）

   （这里可结合**反向代理服务器 Nginx** 和 **Redis** 进行负载均衡，其中会涉及数据和 session 同步的问题）

3. 读写分离

   利用主从结构，主数据库负责写，其他多个从数据库负责读（要避免多个写）

#### 1.2 其他优化

使用 Hibernate 的二级缓存：要注意考虑二级缓存的命中率

### 二、海量数据处理方案

> 本小结参考博客：https://blog.csdn.net/xlgen157387/article/details/53230138

#### 2.1 使用缓存

由于网站访问数据的特点大都呈现为“二八定律”：即80%的业务访问集中在 20% 的数据上。

总的来说，就是用户只用到了总数据条目的一小部分，当网站发展到一定的规模，数据库 IO 成为性能瓶颈的时候，使用缓存的方法，将热门的数据缓存到内存中，不但可以减轻数据库的压力，还可以提高整体网站的数据访问速度。

这种缓存的方式可以通过程序代码将数据直接保存到内存中，例如 Map 或者 ConcurrentHashMap；另外一种就是使用缓存框架：Redis、Ehcache、Mencache 等。

由于内存的资源有限，因此如何创建缓存是一个值得考虑的问题。另外，对于缓存待定失效机制也是需要好好设计的，失效机制可以通过设置失效时间的方式进行设置；也可以通过对热门数据设置优先级，根据优先级设置不同的失效时间。

而且需要注意的是，当我们 delete 掉一条数据的时候，要考虑到一并删除数据所对应的缓存中的记录，还要考虑在删除这条缓存之前这条数据是否已经到达了缓存失效的时间等各种情况。

最后，使用缓存的时候还要考虑到缓存服务器发生故障时如何进行容错处理，是使用 N 多台服务器缓存相同的数据，然后通过分布式部署的方式对缓存数据进行控制（当一台发生故障的时候自动切换到其他的机器上去）；还是通过 Hash 一致性的方式，等待缓存服务器恢复正常使用的时候重新指定到该缓存服务器。Hash 一致性的另一个作用就是在分布式缓存服务器下对数据进行定位，将数据分布在不同缓存服务器上。关于 Hash 一致性算法可参考：[https://blog.csdn.net/liu765023051/article/details/49408099](https://blog.csdn.net/liu765023051/article/details/49408099)

#### 2.2 页面静态化技术

在传统的 JSP 界面，前端界面的显示是通过后台服务器进行渲染后返回给前端浏览器进行解析执行。而当下所倡导的前后端分离，前端界面基本都是 HTML 网页代码，通过 Angular JS 或者 NodeJS 提供的路由向后端服务器发出请求获取数据，然后在浏览器对数据进行渲染，这样能很大程度上降低后端服务器的压力。

同时，我们还可以将这些静态的 HTML、CSS、JS、图片等静态资源放置在缓存服务器上，或者 CDN 服务器上，一般使用最多的应该是 CDN 服务器或者 Nginx 服务器提供的静态资源功能。

另外在`《高性能网站建设进阶指南-Web开发者性能优化最佳实践（口碑网前端团队 翻译）》`这本书中，对网站性能的前端界面提供了一些很宝贵的经验：

![1558683654025](D:\GitBook\About_Database\assets\1558683654025.png)

#### 2.3 数据库优化

数据库优化是整个网站性能优化的最基础的一个环节，因为大多数网站性能的瓶颈都是开在数据库 IO 操作上，虽然提供了缓存技术，但是对数据库的优化还是一个需要认真对待的问题。

数据库优化的方式很多，常见的可以分为：数据库表结构优化、SQL 语句优化、分区、分表、索引优化、使用存储过程代替直接操作等。

* 表结构优化
  结构优化也可以看作开发规范化，可参考笔记： [数据库开发规范和技巧（MySQL）.md](数据库开发规范和技巧（MySQL）.md) 。
  关于数据表的外键，使用外键的好处之一是可以方便地进行级联删除操作，但是现在一般是在进行数据业务操作的时候，通过事务的方式来保证数据读取操作的一致性。
* SQL优化
* 分表
  分表是将一个大表按照一定的规则分解成多张具有独立存储空间的实体表，我们可以称为子表，每个表都对应三个文件，MYD 数据文件，.MYI 索引文件，.frm 表结构文件。这些子表可以分布在同一块磁盘上，也可以在不同的机器上。数据库读写操作的时候根据事先定义好的规则得到对应的子表名，然后去操作它。
  例如：用户表 
  用户的角色有很多种，可以通过枚举类型的方式将用户分为不同类别 category：学生、教师、企业等，这样的话，我们就可以根据类别 category 来对数据库进行分表，这样的话每次查询的时候现根据用户的类型锁定一个较小的范围。
  不过分表之后，如果需要查询完整的顺序就需要使用多表操作了。
* 分区
  数据库分区是一种物理数据库设计技术，DBA 和数据库建模人员对其相当熟悉。虽然分区技术可以实现很多效果，但其主要目的是为了在特定的 SQL 操作中减少数据读写的总量以缩减响应时间。
  分区和分表相似，都是按照规则分解表。不同在于分表将大表分解为若干个独立的实体表，而分区是将数据分段划分在多个位置存放，可以是同一块磁盘也可以在不同的机器。分区后，表面上还是一张表，但数据散列到多个位置了。数据库读写操作的时候操作的还是大表名字，DMS 自动去组织分区的数据。
  当一张表中的数据变得很大的时候，读取数据，查询数据的效率非常低下，如果使用分表的方案，将数据分到不同的数据表中进行保存，会使得操作起来比较麻烦，同时，将同类的数据分别放在不同的表中的话，在搜索数据的时候需要遍历查询这些表中的数据。想进行 CRUD 操作还需要先找到对应的所有表，如果涉及到不同的表的话还要进行跨表操作，这样操作起来还是很麻烦的。
  使用分区的方式可以解决这个问题，分区是将一张表中的数据按照一定的规则分到不同的区中进行保存，这样进行数据查询的时候如果数据的范围在同一个区域内那么就可以只对一个区中的数据进行操作，这样的话操作起来数据量更少，操作速度更快，而且该方法是对程序透明的，程序不需要进行任何的修改。
* 索引优化
* 使用存储过程代替直接操作
  存储过程（Stored Procedure）是在大型数据库系统中，一组为了完成特定功能的 SQL 语句集，用户通过指定存储过程的名字并给出参数（如果该存储过程带有参数）来执行它。存储过程是数据库中的一个重要对象，任何一个设计良好的数据库应用程序都应该用到存储过程。
  在操作过程比较复杂并且调用频率比较高的业务中，可以将编写好的sql语句用存储过程的方式来代替，使用存储过程只需要进行一次变异，而且可以在一个存储过程里做一些复杂的操作。
  `PS：存储过程：① 存储在数据库中；② 经过第一次编译后再次调用不需要再次编译。`

#### 2.4 分离数据库中活跃的数据

正如前边提到的“二八定律”一样，网站的数据虽然很多，但是经常被访问的数据还是有限的，因此可以将这些相对活跃的数据进行分离，单独进行保存来提高处理效率。
其实前边使用缓存的思想就是一个很明显的分离数据库中活跃的数据的使用案例，将热门数据缓存在内存中。
还有一种场景就是：例如一个网站的注册用户量很大（千万级别），但是经常登录的用户只有百万级别，剩下的基本都是很长时间都没有进行登录操作，如果不把这些“僵尸用户”单独分离出去，那么我们每次查询其他登录用户的时候，就白白浪费了这些僵尸用户的查询操作。

#### 2.5 批量读取和延迟修改

批量读取和延迟修改的原理是通过减少操作数据库的次数来提高效率。
批量读取是将多次查询合并到一次中进行读取，因为每一个数据库的请求操作都需要链接的建立和链接的释放，还是占用一部分资源的，批量读取可以通过异步的方式进行读取。
延迟修改是针对一些高并发的并且修改频繁修改的数据，在每次修改的时候便将数据保存到缓存中，然后定时将缓存中的数据保存到数据库中，程序可以在读取数据时可以同时读取数据库中和缓存中的数据。可以理解为：IDEA 在编程过程中自动保存代码的特性。

#### 2.6 读写分离

读写分离的实质是将应用程序对数据库的读写操作分配到多个数据库服务器上，从而降低单台数据库的访问压力。
读写分离一般通过配置主从数据库的方式，数据的读取来自从库，对数据库增加修改删除操作主库。

#### 2.7 使用  NoSQL  和  Hadoop  等技术

NoSQL 是一种非结构化的非关系型数据库，由于其灵活性，突破了关系型数据库的条条框框，可以灵活的进行操作，另外，因为 NoSQL 通过多个块存储数据的特点，其操作大数据的速度也是相当快的。

#### 2.8 分布式部署数据库

任何强大的单一服务器都满足不了大型网站持续增长的业务需求。数据库通过读写分离之后将一台数据库服务器拆分为两台或者多台数据库服务器，但是仍然满足不了持续增长的业务需求。分布式部署数据库是将网站数据库拆分的最后手段，只有在单表数据规模非常庞大的时候才使用。
即本来只有一个表的性能，现在一句 SQL，n 个相同的表执行，能加快n倍的查询速度。

#### 2.9 应用服务和数据服务分离

应用服务器和数据库服务器进行分离的目的是为了根据应用服务器的特点和数据库服务器的特点进行底层的优化，这样的话能够更好的发挥每一台服务器的特性，数据库服务器当然是有一定的磁盘空间，而应用服务器相对不需要太大的磁盘空间。这样的话进行分离是有好处的，也能防止一台服务器出现问题连带的其他服务也不可以使用。

#### 2.10 使用搜索引擎搜索数据库中的数据

#### 2.11 进行业务的拆分

为什么进行业务的拆分，归根结底上是将不同的业务数据表部署到不用的服务器上，分别查找对应的数据以满足网站的需求。各个应用之间用过指定的URL连接获取不同的服务。
例如：一个大型的购物网站就会将首页、商铺、订单、买家、卖家等拆分为不通的子业务，一方面将业务模块分归为不同的团队进行开发，另外一方面不同的业务使用的数据库表部署到不通的服务器上，使用了拆分的思想。当一个业务模块使用的数据库服务器发生故障也不会影响其他业务模块的数据库正常使用。另外，当其中一个模块的访问量激增的时候还可以动态的扩展这个模块使用到的数据库的数量从而满足业务的需求。

### 三、高并发处理方案

#### 3.1 应用程序和静态资源文件进行分离

所谓的静态资源就是我们网站中用到的 Html、Css、Js、Image、Video、Gif 等静态资源。应用程序和静态资源文件进行分离也是常见的前后端分离的解决方案，应用服务只提供相应的数据服务，静态资源部署在指定的服务器上（Nginx 服务器或者是 CDN 服务器上），前端界面通过 Angular JS 或者 Node JS 提供的路由技术访问应用服务器的具体服务获取相应的数据在前端游览器上进行渲染。这样可以在很大程度上减轻后端服务器的压力。

#### 3.2 页面缓存

页面缓存是将应用生成的很少发生数据变化的页面缓存起来，这样就不需要每次都重新生成页面了，从而节省大量 CPU 资源，如果将缓存的页面放到内存中速度就更快。
可以使用 Nginx 提供的缓存功能，或者可以使用专门的页面缓存服务器 Squid。

#### 3.3 集群与分布式

#### 3.4 反向代理

#### 3.5 CDN