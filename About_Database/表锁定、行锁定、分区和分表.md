# 表锁定、行锁定、分区和分表

（本篇笔记主要理解表锁定、行锁定、分区和分表的概念，由于没 merge 引擎分表和分区操作经验，因此只做记录）

### 一、表锁定

任何人都不能对这张表进行操作，必须等操作结束才行。

### 二、行锁定

任何人都不能对这条数据进行操作，必须等操作完了才行。

### 三、分表

分表是将一个大表按照一定的规则分解成多张具有独立存储空间的实体表，每个表都对应三个文件（.MYD 数据文件；.MYI 索引文件；.frm 表结构文件）。这些表可以分布在同一块磁盘上，也可以在不同的机器上。app 读写的时候根据事先定义好的规则得到对应的表名，然后去操作它。

将单个数据库表进行拆分，拆分成多个数据表，然后用户访问的时候，根据一定的算法（如用 hash 的方式，也可以用求余（取模）的方式），让用户访问不同的表，这样数据分散到多个数据表中，减少了单个数据表的访问压力。提升了数据库访问性能。分表的目的就在于此，减小数据库的负担，缩短查询时间。

**Mysql 分表分为垂直切分（纵向分表）和水平切分（横向分表）**

#### 3.1 垂直切分

垂直切分是指数据表列的拆分，把一张列比较多的表拆分为多张表。

通常我们按以下原则进行垂直拆分：
$$\begin{cases}经常组合查询的列放在一张表中，把不常用的字段单独放在另一张表；
\\把 text、blob（binary、large、object、二进制大对象）等大字段拆分出来放在附表中\end{cases}$$

垂直拆分更多时候就应该在数据表设计之初就执行的步骤，然后查询的时候用 join 关键起来即可。

#### 3.2 水平拆分

水平拆分是指数据表行的拆分，把一张的表的数据拆成多张表来存放。

##### 3.2.1 水平拆分原则

通常情况下，我们使用 hash、取模等方式来进行表的拆分。

比如一张有 400W 的用户表 users，为提高其查询效率我们把其分成4张表：users1、users2、users3、users4，通过用 ID 取模的方法把数据分散到四张表内 Id%4=[0,1,2,3]，然后查询、更新、删除也是通过取模的方法来查询，部分业务逻辑也可以通过地区、年份等字段来进行归档拆分；

进行拆分后的表，这时我们就要约束用户查询行为。比如我们是按年来进行拆分的，这个时候在页面设计上就约束用户必须要先选择年，然后才能进行查询。

##### 3.2.2 分表的几种方式

1. MySQL 集群
   MySQL 集群并不是分表，但起到了和分表相同的作用。集群可分担数据库的操作次数，将任务分担到多台数据库上。集群可以读写分离，减少读写压力。从而提升数据库性能。
2. 预先估计会出现大数据量并且访问频繁的表，将其分为若干个表。
   根据一定的算法（如用 hash 的方式，也可以用求余（取模）的方式）让用户访问不同的表。
3. 利用 merge 存储引擎来实现分表。
   把已有的大数据量表分开是比较难搞的事情，最痛苦的事就是改代码，因为程序里面的 sql 语句已经写好了，这时可以考虑采用 merge 存储引擎来实现分表。
   merge 分表，分为主表和子表，主表类似于一个壳子，逻辑上封装了子表，实际上数据都是存储在子表中的。
   我们可以通过主表插入和查询数据，如果清楚分表规律，也可以直接操作子表。

### 四、分区

分区和分表相似，都是按照规则分解表。不同在于分表将大表分解为若干个独立的实体表，而分区是将数据分段划分在多个位置存放，分区后，表还是一张表，但数据散列到多个位置了。app 读写的时候操作的还是表名字，db 自动去组织分区的数据。

#### 4.1 分区主要有两种形式

1. 水平分区（Horizontal Partitioning）
   这种形式分区是对表的行进行分区，所有在表中定义的列在每个数据集中都能找到，所以表的特性依然得以保持。
   举个简单例子：一个包含十年发票记录的表可以被分区为十个不同的分区，每个分区包含的是其中一年的记录。
2. 垂直分区（Vertical Partitioning）
   这种分区方式一般来说是通过对表的垂直划分来减少目标表的宽度，使某些特定的列被划分到特定的分区，每个分区都包含了其中的列所对应的行。
   举个简单例子：一个包含了大 text 和 BLOB 列的表，这些 text 和 BLOB 列又不经常被访问，这时候就要把这些不经常使用的 text 和 BLOB 了划分到另一个分区，在保证它们数据相关性的同时还能提高访问速度。

### 五、MySQL分表和分区区别

#### 5.1 实现方式上

* MySQL 的分表是真正的分表，一张表分成很多表后，每一个小表都是完整的一张表，都对应三个文件，一个 .MYD 数据文件，.MYI 索引文件，.frm 表结构文件。
* 分区不一样，一张大表进行分区后，他还是一张表，不会变成二张表，只是存放数据的区块变多了。

#### 5.2 数据处理上

* 分表后，数据都是存放在分表里，总表只是一个外壳，存取数据发生在一个一个的分表里面。
* 分区则是把存放数据的文件分成了许多小块，分区后的表呢，还是一张表，数据处理还是由自己来完成。

#### 5.3 提高性能上

* 分表后，单表的并发能力提高了，磁盘 I/O 性能也提高了。并发能力为什么提高了呢，因为查寻一次所花的时间变短了，如果出现高并发的话，总表可以根据不同的查询，将并发压力分到不同的小表里面。
* MySQL 提出了分区的概念，主要是想突破磁盘 I/O 瓶颈，想提高磁盘的读写能力，来增加 MySQL 性能。在这一点上，分区和分表的测重点不同，分表重点是存取数据时，如何提高 MySQL 并发能力上；而分区呢，如何突破磁盘的读写能力，从而达到提高 MySQL 性能的目的。

#### 5.4 实现的难易度上

* 分表的方法有很多，使用 merge 引擎来分表，是最简单的一种方式。这种方式跟分区难易度差不多，并且对程序代码来说可以做到透明的。如果是用其他分表方式就比分区麻烦了。
* 分区实现是比较简单的，建立分区表，跟建平常的表没什么区别，并且对代码端来说是透明的。

### 六、MySQL 分表和分区联系

1. 都能提高 MySQL 的性能，在高并发状态下都有一个良好的表现。
2. 分表和分区不矛盾，可以相互配合的，对于那些大访问量，并且表数据比较多的表，我们可以采取分表和分区结合的方式，访问量不大，但是表数据很多的表，我们可以采取分区的方式等。
3. 分表技术是比较麻烦的，需要手动去创建子表，app 服务端读写时候需要计算子表名。采用 merge 好一些，但也要创建子表和配置子表间的 union 关系。
4. 表分区相对于分表，操作方便，不需要创建子表。